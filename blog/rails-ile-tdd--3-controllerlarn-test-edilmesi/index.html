<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="0emXjEbk_ZIziWSlcEWaCEaOIivGlP2tiGnQPLvZKNE" />
    <title>Rails ile TDD - 3 (Controller'ların test edilmesi)</title>
    
    <meta name="description" content="Ruby, JavaScript, Clojure ve diğer yazılım maceralarım
">
    
    <link rel="canonical" href="http://www.turhancoskun.com/blog/rails-ile-tdd--3-controllerlarn-test-edilmesi/">
    <link href='http://fonts.googleapis.com/css?family=PT+Serif:400,700,400italic,700italic|Didact+Gothic&subset=latin,latin-ext' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/assets/app-7b6ef52fde1161ca11ee182475dc0a7e.css">
</head>


<body class="showing-post">
  <div class="pure-g">
    <div class="content pure-u-1 pure-u-md-3-4">
      <div>
          <div class="post-nav-bar pure-g">
            <div class="pure-u-1-3">
              <figure>
                <a href="/">
                  <img class="post-avatar" src="/assets/profile200x200.jpg" alt="Turhan Coskun" />
                </a>
              </figure>
            </div>
            <div class="blog-name pure-u-1-3">
              <div><a href="/">Turhan Coskun</a></div>
            </div>
            <div class="pure-u-1-3">
            </div>
          </div>

        <div class="post">
          <header class="post-header">
            <h1 class="post-title">Rails ile TDD - 3 (Controller'ların test edilmesi)</h1>
            <div class="post-meta">Nov 17, 2014
            <div>
              
              <a class="post-category" href="/tag/Ruby">Ruby</a>
              
              <a class="post-category" href="/tag/Ruby on Rails">Ruby on Rails</a>
              
              <a class="post-category" href="/tag/TDD">TDD</a>
              
              <a class="post-category" href="/tag/Dersler">Dersler</a>
              
            </div>
            </div>
          </header>

          <article class="post-content">
            <p>Yazı dizimizin üçüncü bölünme MVC’nin C’si yani Controller testlerinin nasıl
yapıldığını öğreneceğiz.</p>

<p>Controller testleri aslında birçok yönden model testlerinden farklı değiller.
Controller testlerinin en büyük faydalarından biri de kodumuzda büyük ölçekli
refactor işlemleri uyguladığımızda, uygulamamızda  meydana gelen davranış şekillerinin
zamanında farkedilerek can simidi vazifesi görmeleri olacaktır.</p>

<p><strong>Peki controller üzerinde neleri test edeceğiz?</strong>
Bu sorunun yanıtı biraz geliştiriciye ve uygulamaya bağlı olsa da bazı temel
şeyleri mutlaka test etmenizi öneririm.</p>

<ul>
  <li>Mime Type: Dönen yanıt istediğimiz formatta mı? html, json, xml vs.</li>
  <li>Http Status: Dönen http yanıt kodu doğru mu? 201, 200, 400, 403 vs</li>
  <li>Template: Bizim istediğimiz şablon mu gösteriliyor? new, edit vs.</li>
</ul>

<p>TDD ile geliştirme yaparken sürekli editör ile konsol arasında gidip gelmek yorucu
olabilir. Böyle bir durumda eğer benim gibi text editör olarak vim kullanıyorsanız
tmux adındaki terminal çoklayıcı kullanarak ekranı bölebilir ve hatta guard gibi
bazı ruby gemleri yardımıyla test dosyalarınız değiştikçe otomatik çalışmalarını
sağlayabilirsiniz. Daha sonra Rails geliştirme ortamları hakkında ayrı bir yazı yazarak,
kıyaslamalar yapmayı ve bu konu hakkında fikirler paylaşmayı düşünüyorum.</p>

<p>Yazının bu kısmından itibaren controller yerine denetleyici tanımını kullanacağım. O yüzden
bu denetleyici nereden çıktı diye şaşırmayın derim.</p>

<h2 id="users-denetleyicisi">Users Denetleyicisi</h2>

<p>Öncelikle User denetleyicisi için test yazacağız ve bu sefer herşeyi manuel gerçekleştirelim.
Yani rails generate komutu kullanmak yerine dosyaları bir bir kendimiz oluşturalım.
Rails ile denetleyici testlerini manuel yoldan geçirebilirseniz bu işin mantığını büyük çoğunlukla
anlamışsınız demektir.</p>

<p>Genel Beklentilerimiz:
1. User email adresini girdiğinde email, daha önce kayıtlı ise doğrudan Todo listesine yönlenecek
2. Email adresi kayıtlı değilse, email adresi veri tabanına kaydedilip, todo listesine yönlececek</p>

<p>Model testlerimizin spec klasörü altında models isimli dizinde tutulduğunu önceki bölümden
hatırlayın. Şimdi ise bize gereken bir controllers/ dizini.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git checkout -b users-controller
mkdir spec/requests</code></pre></div>

<p>Şimdi ise yeni oluşturduğumuz controllers dizininde users_spec.rb isimli bir dosya oluşturun.
Denetleyici tanımları çoğul eki ile yapıldığı için onun test edileceği spec dosyasını da
bu kurala uygun olarak oluşturduk. Daha önce Rails’in birçok önkabul ile işlediğini söylemiştim.
Denetleyici isimlerinin çoğul takısı ile yapılması da bunlardan birisi.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="nb">require</span> <span class="s1">&#39;rails_helper&#39;</span>

<span class="n">describe</span> <span class="no">UsersController</span><span class="p">,</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="ss">:controller</span> <span class="k">do</span>

  <span class="n">describe</span> <span class="s1">&#39;GET #new&#39;</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s1">&#39;assigns a user to @user class variable&#39;</span>
  <span class="k">end</span>

  <span class="n">describe</span> <span class="s1">&#39;POST #create&#39;</span> <span class="k">do</span>
    <span class="n">context</span> <span class="s1">&#39;when valid&#39;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">&#39;saves the user to database&#39;</span>
    <span class="k">end</span>

    <span class="n">context</span> <span class="s1">&#39;when invalid&#39;</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s1">&#39;rerenders the :new template&#39;</span>
    <span class="k">end</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></div>

<p>Yazım dili olarak model testlerinden çok da farklı değil gördüğünüz gibi. Tanımlarken
kullandığımız :type artık :model yerine :controller oldu. Testlerde büyük harflerle
http metotlarını ve # karakterinin ardın hangi ‘action’ çağrılacağını belirttik. Okunaklı
testler yazmak açısından bu stil kurallarını takip etmek önemli. Bu konuda daha fazla
bilgiye ulaşmak için <a href="http://betterspecs.org/">Better Specs</a> sitesini incelemenizi tavsiye ederim.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">rspec spec/controllers/users_spec.rb</code></pre></div>

<p>Kodunu çalıştırdığımızda, doğal olarak UsersController diye bir tanım olmadığını söyleyecek.
İlk önce denetleyici tanımını yapmak için app/controllers/users_controller.rb dosyasını oluşturun ve
içeriğini aşağıdaki gibi doldurup kaydedin.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

<span class="k">end</span></code></pre></div>

<p>Testi tekrar çalıştırdığınızda sarı renkte bekleyen testlerin listelendiğini göreceksiniz.</p>

<p>Şimdi users_spec.rb dosyasını tekrar açalım ve aşağıdaki düzenlemeleri yapalım.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">it</span> <span class="s1">&#39;assigns a user to @user class variable&#39;</span> <span class="k">do</span>
  <span class="n">get</span> <span class="ss">:new</span>
  <span class="n">expect</span><span class="p">(</span><span class="n">assigns</span><span class="p">(</span><span class="ss">:user</span><span class="p">))</span><span class="o">.</span><span class="n">to</span> <span class="n">be_a_new</span> <span class="no">User</span>
<span class="k">end</span></code></pre></div>

<p>Test kodumuzu çalıştırdığımızda bize Users#new ile eşleşen bir rota olmadığı hatasını verecek.</p>

<p>config/routes.rb dosyasını açıp gerekli rota eklemesini yapalım. İçerisinde yorum satırı
yapılmış bir sürü örnek rota göreceksiniz. Onları daha sonra incelemeniz için silmiyorum.
Aşağıdaki gibi olacak şekilde koda ekleme yapın.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">routes</span><span class="o">.</span><span class="n">draw</span> <span class="k">do</span>
  <span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="ss">:new</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span>
  <span class="o">.</span><span class="n">.</span><span class="o">.</span></code></pre></div>

<p>Şimdi test kodumuzu tekrar çağırıp kontrol edelim. Aldığımız hata çıktısı :
<em>The action ‘new’ could not be found for UsersController</em> Yani bu hatadan sıyrılmak için
UsersController sınıfında :new adında bir metot oluşturmamız gerekecek. Bunun için
app/controllers/users_controller.rb dosyasını açıyoruz va aşağıdaki gibi düzenliyoruz.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>

  <span class="k">end</span>

<span class="k">end</span></code></pre></div>

<p>Testi çalıştırdığınızda MissingTemplate hatası alacaksınız. Bu hatanın sebebi artık Rails
uygulamamız /users/new url’si çağrıldığında hangi kod dilimini çağırması gerektiğini biliyor
ancak html içeriğinin yerini bulamıyor. Sadece hatanın geçmesini sağlamak için app/views/users/new.html.erb
dosyasını oluşturmanız yeterli.</p>

<p>Unix tabanlı bir sistemde kısaca aşağıdaki komutu yazabilirsiniz.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">mkdir app/views/users
touch app/views/users/new.html.erb
rspec spec/requests/users_spec.rb</code></pre></div>

<p>Artık testimizi geçirmek için sona geldik. Gerekli alt yapının hazırlanması tamamlandı. Şu an
ekranda gördüğünüz hata eksik bir dosya ya da tanımlanmamış bir sınıftan ziyade karşılanılmamış
bir beklenti olması gerekiyor. Yani @user değişkenine yeni bir user atamak. Denetleyici dosyasını
app/controllers/users_controller.rb adresinden tekrar açıp aşağıdaki düzenlemeyi yapın.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>  
  <span class="k">end</span>

<span class="k">end</span></code></pre></div>

<p>Testi çalıştırdığınızda bir yeşilimiz olacak.</p>

<p>spec/controllers/users_spec.rb dosyasını tekrar açarak testlerimizi yazmayı sürdürelim.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">context</span> <span class="s1">&#39;when valid&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;saves the user to database&#39;</span> <span class="k">do</span>
    <span class="n">expect</span> <span class="p">{</span>
      <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;person@example.com&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span>
    <span class="p">}</span><span class="o">.</span><span class="n">to</span> <span class="n">change</span><span class="p">(</span><span class="no">User</span><span class="p">,</span> <span class="ss">:count</span><span class="p">)</span><span class="o">.</span><span class="n">by</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Gördüğünüz gibi burada farklı bir except yapısı kullandık. Rspec belgelendirmelerini
incelerseniz bu tip farklı yaklaşımlarla karşılaşabilirsiniz. Burada post metodunun
kullanı sayısını 1 arttırmasını bekliyoruz.</p>

<p>Testi çalıştırın. No route yazısı ile karşılaştıysanız nereden başlamamız gerektiğini
tahmin edersiniz diye umuyorum.</p>

<p>Hemen config/routes.rb dosyasını tekrar açıp daha önce yazdığımız satırı aşağıdaki gibi
dikkatlice düzenleyin.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resources</span> <span class="ss">:users</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span></code></pre></div>

<p>Not: Burada only: kısmının artık bir array (dizi değişkeni) olduğuna dikkat edin.</p>

<p>Testi çalıştırın ve göreceksiniz ki :
<em>The action ‘create’ could not be found for UsersController</em></p>

<p>Post olayı için yazdığımız beklentilere bakarsanız, veri tabanına başarı ile kaydetmesini
hata olması halinde ise yeniden :new şablonunu görüntülemesini istiyoruz. Denetleyici
dosyası açıp aşağıdaki gibi düzenleyin.</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>

  <span class="k">def</span> <span class="nf">new</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>  
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">create</span>
    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
    <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
      <span class="n">session</span><span class="o">[</span><span class="ss">:user_id</span><span class="o">]</span> <span class="o">=</span> <span class="vi">@user</span><span class="o">.</span><span class="n">id</span>
      <span class="n">redirect_to</span> <span class="ss">:todos</span>
    <span class="k">else</span>
      <span class="n">render</span> <span class="ss">:new</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="kp">private</span>
  <span class="k">def</span> <span class="nf">user_params</span>
    <span class="n">params</span><span class="o">.</span><span class="n">require</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span><span class="o">.</span><span class="n">permit</span><span class="p">(</span><span class="ss">:email</span><span class="p">)</span>
  <span class="k">end</span>

<span class="k">end</span></code></pre></div>

<p>Burada değinmem gereken birkaç nokta olduğunu düşünüyorum. Öncelikle user_params
diyerek izin verilen parametreleri tek tek bildirmemiz gerekiyor. Rails’in bu özelliğine
<em>Strong Parameters</em> deniliyor. Uygulamaların güvenliği açısında müthiş bir özellik. Daha
ayrıntılı bilgiyi <a href="http://edgeapi.rubyonrails.org/classes/ActionController/StrongParameters.html">buraya</a>
tıklayarak bulabilirsiniz.</p>

<p>session ile kullanıcı id’sini depoladık. Bu basitçe bize Todos kısımlarına girdiğimizde
yetkilendirme yapmamızı sağlayacak. redirect_to :todos kısmı kodu çalıştırdığınız anda
öyle bir rota tanımı olmadığı için hata verecektir. Bu kısmı kestirme geçmek için config/routes.rb
dosyasında daha önce User tanımı için yaptığımız rota tanımının hemen altına</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">resources</span> <span class="ss">:todos</span></code></pre></div>

<p>satırını ekleyin. Bu gerekli tanımların oluşmasını otomatik olarak sağlayacaktır.
@user.save ifadesi bize bir boolean yani true-false yanıtı döndürüyor. Bunu koşullandırma
ifadesi içine alırken bir hata oluşması durumunda tekrar :new şablonunu göstermesi gereken
kısmı da boş geçmedik.</p>

<p>Son tanımladığımız rotadan sonra rotaların ne durumda olduğunu test etmek için terminal
ekranına</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">rake routes</code></pre></div>

<p>komutunu girerek otomatik oluşturan rota yardımcı metotlarını inceleyebilirsiniz.</p>

<p>Şimdi test kodumuzu çalıştırdığımızda testimizin geçmesi gerekiyor.</p>

<p>Test dosyamızı açarak düzenlemeye devam edelim:</p>

<div class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">context</span> <span class="s1">&#39;when invalid&#39;</span> <span class="k">do</span>
  <span class="n">it</span> <span class="s1">&#39;rerenders the :new template&#39;</span> <span class="k">do</span>
    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">email</span><span class="p">:</span> <span class="s1">&#39;wrong email&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">attributes</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="o">.</span><span class="n">to</span> <span class="n">render_template</span> <span class="ss">:new</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></div>

<p>Gördüğün gibi testlerimiz artık hatalı bir email adresi olduğunu da farkedebiliyor.</p>

<p>User denetleyici ile yazılan testlerin sonuna geldik. Burada dikkat ederseniz bütün adımları
elle oluşturarak geldik. TDD öğrenmek için bu şekilde basit bir denetleyici oluşturup
olabildiğince çok adıma yaymam gerekiyordu. Tabiki pratikte bu kadar basit adımları manuel
yapmak çok da efektif olmayabilir. Denetleyici için mutlaka test yazın ama bu testleri
rails generator kullandıktan sonra da yazabilirsiniz. Tıpkı TodosController oluşturduktan sonra
yapacağımız gibi. Değişiklikleri git repomuza kaydedip devam edelim.</p>

<div class="highlight"><pre><code class="language-bash" data-lang="bash">git add --all
git commit -m <span class="s2">&quot;Users Controller ve Testleri&quot;</span></code></pre></div>

<h2 id="todos-denetleyicisi">Todos Denetleyicisi</h2>

<p>TDD mantığını büyük ölçüde anladığımıza göre artık işleri biraz daha hızladırmak adına
Todos denetleyicinin tüm yapım aşamalarını burada tek tek açıklamayacağım. Ancak çalışan
bir versiyonunu GitHub reposundan her zaman inceleyebilirsiniz.</p>

<p><a href="https://github.com/turhancoskun/rails-ile-tdd">https://github.com/turhancoskun/rails-ile-tdd</a></p>

          </article>

          <div class="social-share">
            <span>
              <a href="https://twitter.com/share" class="twitter-share-button" data-url="" data-via="turhanco" data-lang="tr">Tweet</a>
            </span>
            <span>
              <div class="fb-like" data-href="" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true">
              </div>
            </span>
          </div>

          <div id="disqus_thread"></div>
          <script type="text/javascript">
            var disqus_shortname = 'turhancoskunblog';
            (function() {
              var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
          </script>

          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          <div id="fb-root"></div>

          <script>(function(d, s, id) {
            var js, fjs = d.getElementsByTagName(s)[0];
            if (d.getElementById(id)) return;
            js = d.createElement(s); js.id = id;
            js.src = "//connect.facebook.net/tr_TR/sdk.js#xfbml=1&appId=1469686916649684&version=v2.0";
            fjs.parentNode.insertBefore(js, fjs);
          }(document, 'script', 'facebook-jssdk'));</script>

          <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
          <p>
            <a href="/">Ana Sayfaya Dön</a>
          </p>

        </div>
      </div>
    </div>

  </div>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-41396472-1', 'auto');
    ga('require', 'displayfeatures');
    ga('send', 'pageview');

  </script>
  <script src="/assets/post-e3735e9638732d7a3306d3a8c6346e84.js"></script>
</body>

</html>
